name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      # Clean Next.js cache before building
      - name: Clean build cache
        run: |
          Write-Output "üßπ Cleaning Next.js build cache..."
          if (Test-Path ".next") {
            Remove-Item -Path ".next" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Output "‚úÖ Removed .next cache"
          }
          Write-Output "üßπ Cleaning npm cache..."
          npm cache clean --force
          Write-Output "‚úÖ Cache cleaning completed"
        continue-on-error: false
        
      - name: Build project
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NODE_ENV: production
          
      - name: Stop service and deploy build
        run: |
          Write-Output "============================================"
          Write-Output "üöÄ STARTING DEPLOYMENT PROCESS"
          Write-Output "============================================"
          
          # Stop service
          Write-Output "`nüìõ Stopping service..."
          C:\Apps\nssm.exe stop PlanningApp
          Start-Sleep -Seconds 20
          
          $status = C:\Apps\nssm.exe status PlanningApp
          Write-Output "Service status: $status"
          
          # Force kill Node processes
          Write-Output "`nüíÄ Checking for lingering Node.js processes..."
          $nodeProcesses = Get-Process -Name "node" -ErrorAction SilentlyContinue
          if ($nodeProcesses) {
            Write-Output "Found $($nodeProcesses.Count) Node.js process(es), force stopping..."
            Stop-Process -Name "node" -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 5
            Write-Output "‚úÖ Processes killed"
          } else {
            Write-Output "‚úÖ No lingering processes"
          }
          
          Write-Output "`n‚è≥ Waiting for file handles to release..."
          Start-Sleep -Seconds 15
          Write-Output "‚úÖ Wait complete"
          
          # Verify source build exists
          Write-Output "`nüîç Verifying source build..."
          if (Test-Path "$env:GITHUB_WORKSPACE\.next\standalone") {
            Write-Output "‚úÖ Source build found at: $env:GITHUB_WORKSPACE\.next\standalone"
            
            # Show what's in the source build
            $sourceBuildId = Get-Content "$env:GITHUB_WORKSPACE\.next\standalone\.next\BUILD_ID" -ErrorAction SilentlyContinue
            Write-Output "Source BUILD_ID: $sourceBuildId"
            
            # Check for Navbar in source
            $navbarCheck = Select-String -Path "$env:GITHUB_WORKSPACE\components\Navbar.tsx" -Pattern "Encomendas de Cliente" -ErrorAction SilentlyContinue
            if ($navbarCheck) {
              Write-Output "‚úÖ 'Encomendas de Cliente' found in source Navbar"
            } else {
              Write-Output "‚ö†Ô∏è  'Encomendas de Cliente' NOT found in source Navbar"
            }
          } else {
            Write-Error "‚ùå Source build not found!"
            exit 1
          }
          
          # Deploy
          Write-Output "`nüì§ Deploying to production..."
          
          # Remove old build
          if (Test-Path "C:\Apps\Sotkon-Planning\.next\standalone") {
            Write-Output "Removing old production build..."
            Remove-Item -Path "C:\Apps\Sotkon-Planning\.next\standalone" -Recurse -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 5
            Write-Output "‚úÖ Old build removed"
          }
          
          # Ensure parent directory exists
          if (-not (Test-Path "C:\Apps\Sotkon-Planning\.next")) {
            New-Item -Path "C:\Apps\Sotkon-Planning\.next" -ItemType Directory -Force | Out-Null
          }
          
          # Copy with robocopy (verbose output)
          Write-Output "`nCopying standalone build..."
          $robocopyOutput = robocopy "$env:GITHUB_WORKSPACE\.next\standalone" "C:\Apps\Sotkon-Planning\.next\standalone" /E /R:3 /W:5
          Write-Output $robocopyOutput
          
          if ($LASTEXITCODE -gt 7) {
            Write-Error "‚ùå Robocopy standalone failed with exit code: $LASTEXITCODE"
            exit 1
          }
          Write-Output "‚úÖ Standalone copied"
          
          # Copy public
          if (Test-Path "$env:GITHUB_WORKSPACE\public") {
            Write-Output "`nCopying public folder..."
            $robocopyOutput = robocopy "$env:GITHUB_WORKSPACE\public" "C:\Apps\Sotkon-Planning\.next\standalone\public" /E /R:3 /W:5
            Write-Output $robocopyOutput
            Write-Output "‚úÖ Public copied"
          }
          
          # Copy static
          if (Test-Path "$env:GITHUB_WORKSPACE\.next\static") {
            Write-Output "`nCopying static folder..."
            $robocopyOutput = robocopy "$env:GITHUB_WORKSPACE\.next\static" "C:\Apps\Sotkon-Planning\.next\standalone\.next\static" /E /R:3 /W:5
            Write-Output $robocopyOutput
            Write-Output "‚úÖ Static copied"
          }
          
          # Verify deployment
          Write-Output "`nüîç Verifying deployment..."
          $deployedBuildId = Get-Content "C:\Apps\Sotkon-Planning\.next\standalone\.next\BUILD_ID" -ErrorAction SilentlyContinue
          Write-Output "Deployed BUILD_ID: $deployedBuildId"
          
          if ($deployedBuildId -eq $sourceBuildId) {
            Write-Output "‚úÖ BUILD_IDs match!"
          } else {
            Write-Error "‚ùå BUILD_IDs don't match! Source: $sourceBuildId, Deployed: $deployedBuildId"
            exit 1
          }
          
          # Check deployed files
          $deployedFiles = Get-ChildItem "C:\Apps\Sotkon-Planning\.next\standalone" -Recurse | Measure-Object
          Write-Output "Deployed $($deployedFiles.Count) files"
          
          Write-Output "`n============================================"
          Write-Output "‚úÖ DEPLOYMENT COMPLETE!"
          Write-Output "BUILD_ID: $deployedBuildId"
          Write-Output "============================================"
        continue-on-error: false
          
      - name: Start service
        run: C:\Apps\nssm.exe start PlanningApp
        
      - name: Wait for service to start
        run: Start-Sleep -Seconds 15
        
      - name: Verify service is running
        run: |
          $maxAttempts = 6
          $attempt = 0
          $running = $false
          
          while ($attempt -lt $maxAttempts -and -not $running) {
            $attempt++
            Write-Output "Checking service status (attempt $attempt/$maxAttempts)..."
            
            $status = C:\Apps\nssm.exe status PlanningApp
            Write-Output "Status: $status"
            
            if ($status -eq "SERVICE_RUNNING") {
              $running = $true
              $buildId = Get-Content "C:\Apps\Sotkon-Planning\.next\standalone\.next\BUILD_ID"
              Write-Output "‚úÖ Deploy successful! Service is running with BUILD_ID: $buildId"
            } else {
              if ($attempt -lt $maxAttempts) {
                Write-Output "Service not ready yet, waiting 5 seconds..."
                Start-Sleep -Seconds 5
              }
            }
          }
          
          if (-not $running) {
            Write-Error "Service failed to start after $maxAttempts attempts!"
            exit 1
          }