name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        
      - name: Build project
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NODE_ENV: production
          
      - name: Stop service and deploy build
        run: |
          Write-Output "Stopping service..."
          C:\Apps\nssm.exe stop PlanningApp
          Start-Sleep -Seconds 20
          
          $status = C:\Apps\nssm.exe status PlanningApp
          Write-Output "Service status: $status"
          
          Write-Output "Waiting for file handles to be fully released..."
          Start-Sleep -Seconds 10
          
          Write-Output "Deploying new build..."
          
          # Cleanup old backup if exists
          if (Test-Path "C:\Apps\Sotkon-Planning\.next\standalone.old") {
            Write-Output "Removing previous backup..."
            Remove-Item -Path "C:\Apps\Sotkon-Planning\.next\standalone.old" -Recurse -Force -ErrorAction SilentlyContinue
          }
          
          # Rename current to .old (faster and more reliable than delete)
          if (Test-Path "C:\Apps\Sotkon-Planning\.next\standalone") {
            Write-Output "Moving current build to backup..."
            
            try {
              Rename-Item -Path "C:\Apps\Sotkon-Planning\.next\standalone" -NewName "standalone.old" -Force -ErrorAction Stop
              Write-Output "Current build backed up successfully"
            } catch {
              Write-Output "Warning: Could not rename current build, attempting direct copy..."
            }
          }
          
          # Copy new build
          Write-Output "Copying new standalone build from: $env:GITHUB_WORKSPACE\.next\standalone"
          Copy-Item -Path "$env:GITHUB_WORKSPACE\.next\standalone" -Destination "C:\Apps\Sotkon-Planning\.next\standalone" -Recurse -Force
          
          if (Test-Path "$env:GITHUB_WORKSPACE\public") {
            Write-Output "Copying public folder..."
            Copy-Item -Path "$env:GITHUB_WORKSPACE\public" -Destination "C:\Apps\Sotkon-Planning\.next\standalone\public" -Recurse -Force
          }
          
          if (Test-Path "$env:GITHUB_WORKSPACE\.next\static") {
            Write-Output "Copying static folder..."
            Copy-Item -Path "$env:GITHUB_WORKSPACE\.next\static" -Destination "C:\Apps\Sotkon-Planning\.next\standalone\.next\static" -Recurse -Force
          }
          
          $buildId = Get-Content "C:\Apps\Sotkon-Planning\.next\standalone\.next\BUILD_ID"
          Write-Output "✅ Files copied successfully! New BUILD_ID: $buildId"
        continue-on-error: false
          
      - name: Start service
        run: C:\Apps\nssm.exe start PlanningApp
        
      - name: Wait for service to start
        run: Start-Sleep -Seconds 15
        
      - name: Verify service is running
        run: |
          $maxAttempts = 6
          $attempt = 0
          $running = $false
          
          while ($attempt -lt $maxAttempts -and -not $running) {
            $attempt++
            Write-Output "Checking service status (attempt $attempt/$maxAttempts)..."
            
            $status = C:\Apps\nssm.exe status PlanningApp
            Write-Output "Status: $status"
            
            if ($status -eq "SERVICE_RUNNING") {
              $running = $true
              $buildId = Get-Content "C:\Apps\Sotkon-Planning\.next\standalone\.next\BUILD_ID"
              Write-Output "✅ Deploy successful! Service is running with BUILD_ID: $buildId"
            } else {
              if ($attempt -lt $maxAttempts) {
                Write-Output "Service not ready yet, waiting 5 seconds..."
                Start-Sleep -Seconds 5
              }
            }
          }
          
          if (-not $running) {
            Write-Error "Service failed to start after $maxAttempts attempts!"
            exit 1
          }
          
      - name: Cleanup old build in background
        run: |
          if (Test-Path "C:\Apps\Sotkon-Planning\.next\standalone.old") {
            Write-Output "Cleaning up old build backup..."
            Remove-Item -Path "C:\Apps\Sotkon-Planning\.next\standalone.old" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Output "Cleanup completed"
          }
        continue-on-error: true